<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Chat</title>
    <script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>

</head>
<body>
<h2>WebSocket Chat</h2>
<input type="text" id="name" placeholder="Your name">
<input type="text" id="message" placeholder="Message">
<button id="sendBtn" onclick="sendMessage()" disabled>Send</button>
<ul id="messages"></ul>

<script>
    let stompClient = null;

    function connect() {
        const socket = new SockJS('/ws'); // important: match Spring endpoint `/ws`
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // Enable the button only after connection is established
            document.getElementById("sendBtn").disabled = false;

            stompClient.subscribe('/topic/messages', function (messageOutput) {
                const body = JSON.parse(messageOutput.body);
                const li = document.createElement('li');
                li.textContent = body.from + ": " + body.text;
                document.getElementById("messages").appendChild(li);
            });
        }, function (error) {
            console.error("STOMP connection error:", error);
        });
    }

    function sendMessage() {
        const name = document.getElementById("name").value;
        const message = document.getElementById("message").value;

        if (!stompClient || !stompClient.connected) {
            alert("Not connected to WebSocket yet!");
            return;
        }

        stompClient.send("/app/chat", {}, JSON.stringify({from: name, text: message}));
        document.getElementById("message").value = "";
    }

    connect();
</script>
</body>
</html>
